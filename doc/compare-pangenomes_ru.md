# Сравнение пангеномов

## Произведение пангеномов

Пусть даны пангеномы A и B, построенные на одном множестве
последовательностей.

**Определение**: пангеном C, такой что каждый блок из C
пересекается ровно с одним блоком из A и ровно с одним
блоком из B, состоящий из минимального возможного числа
блоков, назовём **произведением** пангеномов A и B.

### Алгоритм умножения пангеномов

**Задача**: построить произведение C пангеномов A и B.

**Построение**. Опишем алгоритм в форме псевдокода.

```
ДЛЯ КАЖДОГО блока a ИЗ пангенома A:
  ЗАВЕСТИ словарь D, сопоставляющий блоку из B блок из C;
  ДЛЯ КАЖДОГО фрагмента f_a ИЗ блока a:
    НАЙТИ список фрагментов ff_b из пангенома B,
    пересекающихся с фрагментом f_a;
    ДЛЯ КАЖДОГО фрагмента f_b из списка блоков ff_b:
      НАЙТИ блок b из пангенома B, содержащий фрагмент f_b;
      ЕСЛИ словарь D не содержит ключ b:
        ДОБАВИТЬ пару (b, пустой блок) в словарь D;
      НАЙТИ фрагмент-пересечение f_c фрагментов f_a и f_b;
      ДОБАВИТЬ фрагмент f_c в блок D[b];
  ДОБАВИТЬ все блоки из словаря D в ответ.
```

Этот алгоритм можно легко распараллелить по блоку a.

### Свойства произведения блоков

  * если пангеномы A и B равны, то C=A=B;
  * если блок из A равен блоку из B, то равный им блок будет
    и в произведении;
  * если блок из A похож на блок из B, то пересечение этих
    блоков будет в произведении.

## Классификация блоков произведения пангеномов

Пусть даны пангеномы A и B, построенные на одном множестве
последовательностей, и их произведение C.

Разделим блоки произведения на два типа:

  * **общие блоки**,
  * **конфликтные блоки**.

Блок из пангеномов A и B может пересекаться не более чем с одним
общим блоком. Остальные части C попадают в конфликтные блоки.
При выборе общих блоков, блоки произведения ранжируются по
обычным правилам (сначала по числу фрагментов, потом по длине).
Таким образом, наиболее ценные блоки (стабильные) имеют тенденцию
попадать в общие блоки, а наименее ценные (минорные, уникальные) -
в конфликтные блоки.

### Алгоритм классификации блоков произведения

Процедура построения классификации блоков произведения вытекает
из описания классификации, приведённого выше.

Заведём множество `used`, в которые впоследствии будем
заносить "использованные" блоки из A и B.
Отсортируем все блоки произведения по обычным правилам
(сначала по числу фрагментов, потом по длине).
Будем обходить отсортированные блоки от лучшего к худшему.
Для каждого блока c находим соответствующий блок a в пангеноме A
и блок b в пангеноме B. Проверяем наличие блоков a и b
в множестве `used`. Если ни один из них не найден в `used`,
то добавляем их в `used`, а блок c заносим в ответ как общий блок.
Иначе блок c заносим в ответ как конфликтный блок.

### Свойства классификации блоков произведения

  * если пангеномы A и B равны, то всё произведение будет размечено
    как общие блоки;
  * если блок из A равен блоку из B, то равный им блок произведения
    будет размечен как общий блок;
  * если блок из A похож на блок из B, то пересечение этих блоков
    будет размечено как общий блок, а остальные части этих блоков
    будут размечены как конфликтные блоки.

## Расстояние между пангеномами

Пусть даны пангеномы A и B, построенные на одном множестве
последовательностей, их произведение C и классификация блоков
произведения.

Введём меру **абсолютного расстояния** между пангеномами как суммарное
число нуклеотидов в конфликтных блоках, за исключением тех блоков,
которым соответствуют минорные блоки в обоих пангеномах.

**Относительное расстояние** между пангеномами положим равным
отношению относительного расстояния к суммарной длине геномов.

### Свойства расстояния между пангеномами

  * относительное расстояние принимает значения из полуинтервала [0, 1);
  * если пангеномы A и B равны, то расстояние равно 0;
  * если блок из A равен блоку из B, то они не дают вклада в расстояние;
  * если блок из A похож на блок из B, то вклад в расстояние дают
    несовпадающие части этих блоков;
  * если блок из A распадается на два блока в B, то вклад в расстояние
    даёт меньший из этих двух блоков;
  * если блок из A распадается на несколько блоков bb в B, то вклад в
    расстояние дают все блоки bb, кроме самого большого.
